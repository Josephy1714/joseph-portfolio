{% extends "showcase/base.html" %}
{% load static %}
<link rel="stylesheet" href="{% static 'showcase/chat.css' %}">

{% block title %}Ask Jay ‚Äî Portfolio Assistant{% endblock %}

{% block content %}
<div class="section">
  <h1 class="glow-textured-title">Ask Jay</h1>

  <!-- Chat Container -->
  <div id="chat-box" class="chat-box">
    <div class="chat-row bot-row">
      <div class="chat-message bot">üëã Hi, I‚Äôm Jay. How can I help?</div>
    </div>
  </div>

  <!-- Input Area -->
  <form id="chat-form" class="chat-form">
    <input type="text" id="user-input" placeholder="Type your message..." required>
    <button type="submit" class="glow-button">
  ‚ñ∂
</button>
  </form>

  <!-- Back Button -->
  <a href="{% url 'home' %}" class="back-button">‚Üê Back</a>
</div>

<script>
document.getElementById("chat-form").addEventListener("submit", async function(e) {
  e.preventDefault();
  const box = document.getElementById("chat-box");
  const input = document.getElementById("user-input");
  const text = input.value.trim();
  if (!text) return;

  // Add user message
  const userRow = document.createElement("div");
  userRow.className = "chat-row user-row";
  const userBubble = document.createElement("div");
  userBubble.className = "chat-message user";
  userBubble.textContent = text;
  userRow.appendChild(userBubble);
  box.appendChild(userRow);

  // Show "typing..." placeholder
  const botRow = document.createElement("div");
  botRow.className = "chat-row bot-row";
  const botBubble = document.createElement("div");
  botBubble.className = "chat-message bot";
  botBubble.innerHTML = 'Jay is typing <div class="typing-dots"><span></span><span></span><span></span></div>';
  botRow.appendChild(botBubble);
  box.appendChild(botRow);

  // Reset input and scroll
  input.value = "";
  box.scrollTop = box.scrollHeight;

  // Call backend
  try {
    const res = await fetch("/chat/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ message: text })
    });

    if (!res.ok) {
      botBubble.textContent = "Sorry ‚Äî something went wrong.";
      return;
    }

    const data = await res.json();

    // Add a 2-second delay so typing dots stay visible
    setTimeout(() => {
      // Replace typing bubble with actual reply
      botBubble.innerHTML = ""; // clear typing
      const replyBubble = document.createElement("div");
      replyBubble.className = "chat-message bot";
      replyBubble.textContent = data.reply || "No reply received.";

      const replyRow = document.createElement("div");
      replyRow.className = "chat-row bot-row";
      replyRow.appendChild(replyBubble);

      box.replaceChild(replyRow, botRow);
      box.scrollTo({
        top: box.scrollHeight,
        behavior: "smooth"
      });
    }, 2000);
  } catch (err) {
    botBubble.textContent = "Network error ‚Äî try again.";
  }
});
</script>
{% endblock %}
